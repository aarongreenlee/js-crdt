!function(f){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=f();else if("function"==typeof define&&define.amd)define([],f);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).crdt=f()}}(function(){return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n||e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){"use strict";function merge(a,b){return a.merge(b)}function equal(a,b){return a.equal(b)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.merge=merge,exports.equal=equal,exports.compare=function(a,b){return a.compare(b)},exports.concat=function(a,b){return a.concat(b)},exports.between=function(value,min,max){return!(value<=min||value>=max)},exports.axioms=function(assert,a,b,c){assert(equal(merge(a,b),merge(b,a)),"is not commutative"),assert(equal(merge(a,merge(b,c)),merge(merge(a,b),c)),"is not associative"),assert(equal(merge(a,a),a),"is not idempotent")}},{}],2:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});class Increment{constructor(value){this.value=value,this.value=value}merge(b){return new Increment(Math.max(this.value,b.value))}equal(b){return this.value===b.value}increment(){return new Increment(this.value+1)}}exports.Increment=Increment},{}],3:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const functions=require("./functions"),increment=require("./increment"),order=require("./order"),structures=require("./structures"),text=require("./text");exports.default={functions:functions,increment:increment,order:order,structures:structures,text:text}},{"./functions":1,"./increment":2,"./order":5,"./structures":7,"./text":15}],4:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const naive_array_list_1=require("../structures/naive-array-list"),sorted_set_array_1=require("../structures/sorted-set-array"),vector_clock_1=require("./vector-clock"),emptyVector=new sorted_set_array_1.SortedSetArray(new naive_array_list_1.NaiveArrayList([]));exports.createVectorClock=function(id,version,vector){return new vector_clock_1.VectorClock(new vector_clock_1.Id(id,version||0),vector||emptyVector)}},{"../structures/naive-array-list":8,"../structures/sorted-set-array":12,"./vector-clock":6}],5:[function(require,module,exports){"use strict";function __export(m){for(var p in m)exports.hasOwnProperty(p)||(exports[p]=m[p])}Object.defineProperty(exports,"__esModule",{value:!0}),__export(require("./vector-clock")),__export(require("./factory"))},{"./factory":4,"./vector-clock":6}],6:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});class Id{constructor(node,version){this.node=node,this.version=version,this.node=node,this.version=version}next(){return new Id(this.node,this.version+1)}compare(b){return this.node.localeCompare(b.node)}toString(){return`Id(${this.node},${this.version})`}}exports.Id=Id;class VectorClock{constructor(id,vector){this.id=id,this.vector=vector,this.id=id;let{result:result,value:value}=vector.add(id);result===vector&&id.version>value.version&&(result=vector.remove(value).result.add(id).result),this.vector=result}toString(){const a=this.vector.reduce((r,i)=>r+i.toString(),"");return`VectorClock(${this.id},${a})`}next(){return new VectorClock(this.id.next(),this.vector.remove(this.id).result.add(this.id.next()).result)}equal(b){return this.vector.size()===b.vector.size()&&this.vector.reduce((eq,item)=>{if(eq){const{result:result,value:value}=b.vector.add(item);if(result===b.vector)return value.version===item.version}return!1},!0)}compare(b){return this.lessThan(b)?-1:b.lessThan(this)?1:this.equal(b)?0:this.id.compare(b.id)}lessThan(b){const{everyLEQ:everyLEQ,anyLT:anyLT}=this.vector.intersect(b.vector).reduce(({everyLEQ:everyLEQ,anyLT:anyLT},item)=>{const rA=this.vector.add(item).value,rB=b.vector.add(item).value;return anyLT=anyLT||rA.version<rB.version,everyLEQ=everyLEQ?rA.version<=rB.version:everyLEQ,{everyLEQ:everyLEQ,anyLT:anyLT}},{anyLT:!1,everyLEQ:!0});return everyLEQ&&(anyLT||this.vector.size()<b.vector.size())}merge(b){const vector=this.vector.reduce((vector,item)=>{const{result:result,value:value}=b.vector.add(item);return result===b.vector&&value.version>item.version?vector.add(value).result:vector.add(item).result},this.vector.mempty());return new VectorClock(this.id,vector.union(b.vector))}}exports.VectorClock=VectorClock},{}],7:[function(require,module,exports){"use strict";function __export(m){for(var p in m)exports.hasOwnProperty(p)||(exports[p]=m[p])}Object.defineProperty(exports,"__esModule",{value:!0}),__export(require("./naive-array-list")),__export(require("./naive-immutable-map")),__export(require("./set-axioms")),__export(require("./ordered-map")),__export(require("./sorted-set-array"))},{"./naive-array-list":8,"./naive-immutable-map":9,"./ordered-map":10,"./set-axioms":11,"./sorted-set-array":12}],8:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});class NaiveArrayList{constructor(array){this.array=array||[]}insert(at,item){const clone=this.array.slice(0);return clone.splice(at,0,item),new NaiveArrayList(clone)}remove(at){const clone=this.array.slice(0);return clone.splice(at,1),new NaiveArrayList(clone)}get(at){return this.array[at]}size(){return this.array.length}reduce(fn,aggregator){return this.array.reduce(fn,aggregator)}mempty(){return new NaiveArrayList}}exports.NaiveArrayList=NaiveArrayList},{}],9:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});class NaiveImmutableMap{constructor(data){this.data=data,this.data=data||{}}set(key,value){const clone=Object.keys(this.data).reduce((clone,k)=>(clone[k]=this.data[k],clone),{});return clone[key]=value,new NaiveImmutableMap(clone)}get(key){return this.data[key]}}exports.NaiveImmutableMap=NaiveImmutableMap},{}],10:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});class Indexed{constructor(value,index){this.value=value,this.index=index}compare(b){return this.value.compare(b.value)}}exports.Indexed=Indexed;class OrderedMap{constructor(keys,values){this.keys=keys,this.values=values}set(key,value){const result=this.keys.add(new Indexed(key,this.keys.size()));return new OrderedMap(result.result,this.values.set(result.value.index,value))}get(key){const result=this.keys.add(new Indexed(key,this.keys.size()));return result.result!==this.keys?null:this.values.get(result.value.index)}merge(b){return b.reduce((aggregator,item,key)=>aggregator.set(key,item),this)}reduce(fn,aggregator){return this.keys.reduce((aggregator,key)=>fn(aggregator,this.values.get(key.index),key.value),aggregator)}}exports.OrderedMap=OrderedMap},{}],11:[function(require,module,exports){"use strict";function equal(a,b){return a.equal(b)}function union(a,b){return a.union(b)}function intersect(a,b){return a.intersect(b)}function difference(a,b){return a.difference(b)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.axioms=function(assert,a,b,c){assert(equal(union(union(a,b),c),union(a,union(b,c))),"associative union"),assert(equal(intersect(intersect(a,b),c),intersect(a,intersect(b,c))),"associative intersect"),assert(equal(union(a,intersect(b,c)),union(intersect(a,b),intersect(a,c))),"union distributes over intersection"),assert(equal(intersect(a,union(b,c)),intersect(union(a,b),union(a,c))),"intersection distributes over union"),assert(equal(difference(a,union(b,c)),intersect(difference(a,b),difference(a,c))),"De Morgan's law for union"),assert(equal(difference(a,intersect(b,c)),union(difference(a,b),difference(a,c))),"De Morgan's law for intersect")}},{}],12:[function(require,module,exports){"use strict";function divide(lower,upper,elements,item,onNew,onExists){const step=upper-lower;if(step<1)return onNew(item,elements,lower);const half=Math.trunc(step/2),idx=lower+half,elm=elements.get(idx),cmp=elm.compare(item);return cmp<0?divide(half?lower+half:upper,upper,elements,item,onNew,onExists):cmp>0?divide(lower,half?upper-half:lower,elements,item,onNew,onExists):onExists(elm,elements,idx)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.divide=divide;class Tuple{constructor(result,value){this.result=result,this.value=value}}exports.Tuple=Tuple;class SortedSetArray{constructor(elements){this.elements=elements}mempty(){return new SortedSetArray(this.elements.mempty())}size(){return this.elements.size()}add(value){return divide(0,this.elements.size(),this.elements,value,(item,elements,lower)=>new Tuple(new SortedSetArray(elements.insert(lower,item)),item),(item,elements)=>new Tuple(this,item))}remove(value){return divide(0,this.elements.size(),this.elements,value,(item,elements,lower)=>new Tuple(this,value),(item,elements,index)=>new Tuple(new SortedSetArray(elements.remove(index)),item))}has(value){return divide(0,this.elements.size(),this.elements,value,()=>!1,()=>!0)}union(b){return b.reduce((result,item)=>result.add(item).result,this)}intersect(b){return this.reduce((result,item)=>b.has(item)?result.add(item).result:result,this.mempty())}difference(b){return this.reduce((result,item)=>b.has(item)?result:result.add(item).result,this.mempty())}equal(b){return this.size()===b.size()&&b.reduce((equal,item)=>equal?this.has(item):equal,!0)}reduce(fn,accumulator){return this.elements.reduce(fn,accumulator)}}exports.SortedSetArray=SortedSetArray},{}],13:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});class Delete{constructor(at,length){this.at=at,this.length=length,this.at=at,this.length=length,this.endsAt=this.at+length}}exports.Delete=Delete},{}],14:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const naive_array_list_1=require("../structures/naive-array-list"),naive_immutable_map_1=require("../structures/naive-immutable-map"),ordered_map_1=require("../structures/ordered-map"),sorted_set_array_1=require("../structures/sorted-set-array"),text_1=require("./text");exports.createFromOrderer=function(order){return new text_1.Text(order,new ordered_map_1.OrderedMap(new sorted_set_array_1.SortedSetArray(new naive_array_list_1.NaiveArrayList([])),new naive_immutable_map_1.NaiveImmutableMap))}},{"../structures/naive-array-list":8,"../structures/naive-immutable-map":9,"../structures/ordered-map":10,"../structures/sorted-set-array":12,"./text":18}],15:[function(require,module,exports){"use strict";function __export(m){for(var p in m)exports.hasOwnProperty(p)||(exports[p]=m[p])}Object.defineProperty(exports,"__esModule",{value:!0}),__export(require("./insert")),__export(require("./delete")),__export(require("./selection")),__export(require("./text")),__export(require("./utils")),__export(require("./factory"))},{"./delete":13,"./factory":14,"./insert":16,"./selection":17,"./text":18,"./utils":19}],16:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});class Insert{constructor(at,value){this.at=at,this.value=value,this.at=at<0?0:at,this.value=String(value),this.length=this.value.length,this.endsAt=this.at+this.length}}exports.Insert=Insert},{}],17:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});class Selection{constructor(origin,at,length){this.origin=origin,this.at=at,this.length=length,this.origin=origin,this.at=at<0?0:at,this.length=length<0?0:length,this.endsAt=this.at+this.length}hasSameOrgin(b){return this.origin===b.origin}moveRightBy(step){return new Selection(this.origin,this.at+step,this.length)}expandBy(length){return new Selection(this.origin,this.at,this.length+length)}isInside(position){return this.at<position&&this.endsAt>position}}exports.Selection=Selection},{}],18:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const functions_1=require("../functions");class Text{constructor(order,setMap){this.order=order,this.setMap=setMap}next(){return new Text(this.order.next(),this.setMap)}apply(operation){let operations=this.setMap.get(this.order);return operations||(operations=[]),operations.push(operation),this.setMap=this.setMap.set(this.order,operations),{operations:operations,order:this.order}}mergeOperations(o){return new Text(functions_1.merge(this.order,o.order),this.setMap.set(o.order,o.operations))}merge(b){return new Text(functions_1.merge(this.order,b.order),functions_1.merge(this.setMap,b.setMap))}equal(b){return functions_1.equal(this.order,b.order)}reduce(fn,accumulator){return this.setMap.reduce((accumulator,operations,order)=>fn(accumulator,{operations:operations,order:order}),accumulator)}}exports.Text=Text},{"../functions":1}],19:[function(require,module,exports){"use strict";function toArray(text){return text.reduce((accumulator,item)=>item.operations.reduce(operationToArray,accumulator),[])}function ensureArrayLength(array,len){return array.length<len&&(array.length=len),array}function operationToArray(data,op){if(op instanceof insert_1.Insert){let copy=data.slice(0);return(copy=ensureArrayLength(copy,op.at)).splice(op.at,0,...op.value.split("")),copy}if(op instanceof delete_1.Delete){if(op.at<0)return data;let copy=data.slice(0);return(copy=ensureArrayLength(copy,op.at)).splice(op.at,op.length),copy}return data}function toString(value){return value.join("")}Object.defineProperty(exports,"__esModule",{value:!0});const delete_1=require("./delete"),insert_1=require("./insert"),selection_1=require("./selection");exports.snapshot=function(text){return text.next()},exports.toArray=toArray,exports.ensureArrayLength=ensureArrayLength,exports.operationToArray=operationToArray,exports.toString=toString,exports.renderString=function(text){return toString(toArray(text))},exports.selectionFunc=function(text,fallback){return text.reduce((accumulator,item)=>item.operations.reduce((selection,op)=>op instanceof selection_1.Selection?op.hasSameOrgin(selection)?op:selection:op instanceof insert_1.Insert?op.at<=selection.at?selection.moveRightBy(op.length):selection.isInside(op.at)?selection.expandBy(op.length):selection:op instanceof delete_1.Delete?op.at<=selection.at?selection.isInside(op.endsAt)?selection.moveRightBy(op.at-selection.at).expandBy(selection.at-op.endsAt):selection.moveRightBy(-op.length):selection.isInside(op.at)?selection.expandBy(-op.length):selection:selection,accumulator),fallback)}},{"./delete":13,"./insert":16,"./selection":17}]},{},[3])(3)});