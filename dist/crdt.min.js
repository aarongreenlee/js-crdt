!function(f){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=f();else if("function"==typeof define&&define.amd)define([],f);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).crdt=f()}}(function(){return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n||e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){"use strict";function merge(a,b){return a.merge(b)}function equal(a,b){return a.equal(b)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.merge=merge,exports.equal=equal,exports.compare=function(a,b){return a.compare(b)},exports.concat=function(a,b){return a.concat(b)},exports.applyOperation=function(operation,data){return operation.apply(data)},exports.axioms=function(assert,a,b,c){a.merge(b);assert(equal(merge(a,b),merge(b,a)),"is not commutative"),assert(equal(merge(a,merge(b,c)),merge(merge(a,b),c)),"is not associative"),assert(equal(merge(a,a),a),"is not idempotent")}},{}],2:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});class Increment{constructor(value){this.value=value}merge(b){return new Increment(Math.max(this.value,b.value))}equal(b){return this.value===b.value}increment(){return new Increment(this.value+1)}}exports.Increment=Increment},{}],3:[function(require,module,exports){"use strict";function __export(m){for(var p in m)exports.hasOwnProperty(p)||(exports[p]=m[p])}Object.defineProperty(exports,"__esModule",{value:!0}),__export(require("./functions")),__export(require("./increment")),__export(require("./utils")),__export(require("./order/index")),__export(require("./text/index"))},{"./functions":1,"./increment":2,"./order/index":5,"./text/index":9,"./utils":11}],4:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const utils_1=require("../utils");class Discrete{constructor(id,vector){(vector=utils_1.clone(vector))[id]=vector[id]||0,this.id=id,this.vector=vector}next(){const vector=utils_1.clone(this.vector);return++vector[this.id],new Discrete(this.id,vector)}merge(b){const vector=utils_1.union(Object.keys(this.vector),Object.keys(b.vector)).reduce((vector,key)=>(vector[key]=Math.max(this.vector[key]||0,b.vector[key]||0),vector),{});return new Discrete(this.id,vector)}equal(b){return 0===this.compare(b)}compare(b){const position=utils_1.common(this.vector,b.vector).reduce((result,key)=>result+(this.vector[key]-b.vector[key]),0);if(0!==position)return position;const dif=utils_1.diff(this.vector,b.vector).length-utils_1.diff(b.vector,this.vector).length;if(0!==dif)return dif;const tipPosition=this.vector[this.id]-b.vector[b.id];if(0!==tipPosition)return tipPosition;const ha=b.vector.hasOwnProperty(this.id),hb=this.vector.hasOwnProperty(b.id);return ha||hb?ha&&!hb?-1:hb&&!ha?1:0:this.id<b.id?-1:1}}exports.Discrete=Discrete},{"../utils":11}],5:[function(require,module,exports){"use strict";function __export(m){for(var p in m)exports.hasOwnProperty(p)||(exports[p]=m[p])}Object.defineProperty(exports,"__esModule",{value:!0}),__export(require("./discrete")),__export(require("./timestamp")),__export(require("./discrete")),__export(require("./timestamp"))},{"./discrete":4,"./timestamp":6}],6:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});class Timestamp{constructor(bucket,time){this.bucket=bucket,this.time=time}next(){return new Timestamp(this.bucket,this.time+1)}compare(b){return this.bucket===b.bucket?this.time-b.time:this.bucket<b.bucket?-1:1}merge(b){return this}equal(b){return!1}}exports.Timestamp=Timestamp},{}],7:[function(require,module,exports){"use strict";function increment(value){return value+1}Object.defineProperty(exports,"__esModule",{value:!0});class Leaf{constructor(value){this.value=value}get leaf(){return this}get left(){return null}get right(){return null}find(fn){if(fn(this.value))return this.value}add(item){const cmp=this.value.compare(item);return 0===cmp?this:cmp<0?new Branch(new Leaf(item),this):cmp>0?new Branch(this,null,new Leaf(item)):void 0}reduce(fn,base){return fn(base,this)}}class Branch{constructor(leaf,left,right){this.leaf=leaf,this.left=left,this.right=right}find(fn){if(fn(this.leaf.value))return this.leaf.value;if(this.left){const fl=this.left.find(fn);if(fl)return fl}if(this.right){const fr=this.right.find(fn);if(fr)return fr}}add(item){const cmp=this.leaf.value.compare(item);return 0===cmp?this:cmp<0?this.right?this.left?new Branch(this.leaf,this.left.add(item),this.right):new Branch(this.leaf,new Leaf(item),this.right):this.left?new Branch(new Leaf(item),this.left.left,this.leaf):new Branch(new Leaf(item),this.leaf,null):cmp>0?this.left?this.right?new Branch(this.leaf,this.left,this.right.add(item)):new Branch(this.leaf,this.left,new Leaf(item)):this.right?new Branch(new Leaf(item),this.leaf,this.right.right):new Branch(new Leaf(item),null,this.leaf):void 0}reduce(fn,base){return base=fn(base,this.leaf),this.left&&(base=this.left.reduce(fn,base)),this.right&&(base=this.right.reduce(fn,base)),base}}class Indexed{constructor(value,index){this.value=value,this.index=index}compare(b){return this.value.compare(b.value)}}class SortedSetFast{constructor(){this.count=0}get length(){return this.reduce(increment,0)}add(value){const val=new Indexed(value,this.count);return this.elements?(this.elements=this.elements.add(val),this.length>this.count&&this.count++):this.elements=new Leaf(val),val.index=this.count,this.count}index(idx){return this.elements?this.elements.find(({index:index})=>index===idx).value:null}reduce(fn,accumulator){return this.elements?this.elements.reduce((accumulator,item)=>fn(accumulator,item.value,item.value.index),accumulator):accumulator}}exports.SortedSetFast=SortedSetFast;class SortedSetArray{constructor(){this.elements=[]}add(value){function divide(lower,upper,elements,item){const step=upper-lower;if(step<1)return elements.splice(lower,0,item),item.index;const idx=lower+step,elm=elements[idx],cmp=elm.compare(val);return cmp<0?divide(idx,upper,elements,item):cmp>0?divide(lower,idx,elements,item):0===cmp?elm.index:void 0}const val=new Indexed(value,this.elements.length);return divide(0,this.elements.length-1,this.elements,val)}index(idx){const r=this.elements.find(({index:index})=>index===idx);return r?r.value:null}reduce(fn,accumulator){return this.elements.reduce((accumulator,item)=>fn(accumulator,item.value,item.index),accumulator)}}exports.SortedSetArray=SortedSetArray},{}],8:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const utils_1=require("../utils");class Delete{constructor(at,length){this.at=at,this.length=length}apply(data){if(this.at<0)return data;let copy=data.slice(0);return(copy=utils_1.ensureArrayLength(copy,this.at)).splice(this.at,this.length),copy}}exports.Delete=Delete},{"../utils":11}],9:[function(require,module,exports){"use strict";function __export(m){for(var p in m)exports.hasOwnProperty(p)||(exports[p]=m[p])}Object.defineProperty(exports,"__esModule",{value:!0}),__export(require("./delete")),__export(require("./insert"));const functions_1=require("../functions"),sorted_set_1=require("../structures/sorted-set");class Text{constructor(order,ordersSet,operationsIndex){this.order=order,this.ordersSet=ordersSet||new sorted_set_1.SortedSetArray,this.operationsIndex=operationsIndex||[],this.index=this.ordersSet.add(order),this.operationsIndex[this.index]=this.operationsIndex[this.index]||[]}next(){return new Text(this.order.next(),this.ordersSet,this.operationsIndex)}apply(operation){this.operationsIndex[this.index].push(operation)}merge(b){const ordersIndexA=this.ordersSet;let operationsIndexA=this.operationsIndex.slice(0);return operationsIndexA=b.operationsIndex.reduce((operationsIndexA,operationsB,orderIndexB)=>{const orderB=b.ordersSet.index(orderIndexB);return orderB?(operationsIndexA[ordersIndexA.add(orderB)]=operationsB,operationsIndexA):operationsIndexA},operationsIndexA),new Text(functions_1.merge(this.order,b.order).next(),ordersIndexA,operationsIndexA)}equal(b){return this.toString()===b.toString()}reduce(fn,accumulator){return this.ordersSet.reduce((accumulator,order,orderIndex)=>this.operationsIndex[orderIndex].reduce((accumulator,operation,index)=>fn(accumulator,operation,order,index),accumulator),accumulator)}forEach(fn){this.ordersSet.reduce((_,order,orderIndex)=>{const operations=this.operationsIndex[orderIndex];return fn({order:order,operations:operations}),_},null)}toString(){return this.reduce((accumulator,operation)=>functions_1.applyOperation(operation,accumulator),[]).join("")}}exports.Text=Text},{"../functions":1,"../structures/sorted-set":7,"./delete":8,"./insert":10}],10:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const utils_1=require("../utils");class Insert{constructor(at,value){this.at=at<0?0:at,this.value=String(value)}apply(data){let copy=data.slice(0);return(copy=utils_1.ensureArrayLength(copy,this.at)).splice(this.at,0,...this.value.split("")),copy}}exports.Insert=Insert},{"../utils":11}],11:[function(require,module,exports){"use strict";function keyToMap(r,i){return r[i]=!0,r}Object.defineProperty(exports,"__esModule",{value:!0}),exports.between=function(value,min,max){return!(value<=min||value>=max)},exports.ensureArrayLength=function(array,len){return array.length<len&&(array.length=len),array},exports.sortNumbers=function(a,b){return a-b},exports.clone=function(obj){var target={};for(const i in obj)obj.hasOwnProperty(i)&&(target[i]=obj[i]);return target},exports.union=function(a,b){return a=a.reduce(keyToMap,{}),b=b.reduce(keyToMap,a),Object.keys(b)},exports.common=function(a,b){return Object.keys(a).reduce((r,k)=>(b.hasOwnProperty(k)&&r.push(k),r),[]).sort()},exports.diff=function(a,b){return Object.keys(a).reduce((r,k)=>(b.hasOwnProperty(k)||r.push(k),r),[])}},{}]},{},[3])(3)});